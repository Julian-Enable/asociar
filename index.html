<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asociar Tarjeta a Google Pay</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
</head>

<body>
    <div class="background-blobs">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <main class="payment-container">
        <div class="card-preview">
            <div class="card-glass">
                <div class="card-header">
                    <span class="chip"></span>
                    <span class="logo">VISA</span>
                </div>
                <div class="card-body">
                    <div class="card-number-preview">•••• •••• •••• ••••</div>
                    <div class="card-details">
                        <div class="card-holder-preview">
                            <span class="label">Titular</span>
                            <span class="value">Nombre Apellido</span>
                        </div>
                        <div class="card-date-preview">
                            <span class="label">Expira</span>
                            <span class="value">MM/AA</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <form id="payment-form" class="payment-form">
            <h1>Asociar Tarjeta</h1>

            <div id="payment-element"></div>

            <button type="submit" class="pay-button" id="submit-btn">
                <span id="button-text">Asociar Tarjeta</span>
                <div id="spinner" style="display:none;">Procesando...</div>
            </button>

            <div id="payment-message" style="display:none;margin-top:1rem;padding:1rem;border-radius:8px;"></div>

            <p class="security-note">
                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                </svg>
                Procesado por Stripe con SSL de 256 bits
            </p>
        </form>
    </main>

    <script>
        const stripe = Stripe('pk_test_51SbmRkPuZHkzQDhbp7L1m2cpYslRplDJCdAZmwnTG78dEFzchOG1cARfG1i4evK0dZMU3TYInufZ7n1oYZhjhFJa00OBcOBcGM');

        let elements;
        let clientSecret;

        initialize();

        async function initialize() {
            try {
                const response = await fetch('/.netlify/functions/create-payment-intent', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                });

                const data = await response.json();
                clientSecret = data.clientSecret;

                elements = stripe.elements({ clientSecret });

                const paymentElement = elements.create('payment');
                paymentElement.mount('#payment-element');
            } catch (error) {
                showMessage('Error al inicializar el pago: ' + error.message);
            }
        }

        document.getElementById('payment-form').addEventListener('submit', handleSubmit);

        async function handleSubmit(e) {
            e.preventDefault();
            setLoading(true);

            const { error } = await stripe.confirmPayment({
                elements,
                confirmParams: {
                    return_url: window.location.origin + '/success.html',
                },
            });

            if (error) {
                showMessage(error.message);
                setLoading(false);
            }
        }

        function showMessage(messageText) {
            const messageContainer = document.getElementById('payment-message');
            messageContainer.textContent = messageText;
            messageContainer.style.display = 'block';
            messageContainer.style.background = 'rgba(239, 68, 68, 0.1)';
            messageContainer.style.color = '#ef4444';
        }

        function setLoading(isLoading) {
            const submitBtn = document.getElementById('submit-btn');
            const spinner = document.getElementById('spinner');
            const buttonText = document.getElementById('button-text');

            if (isLoading) {
                submitBtn.disabled = true;
                spinner.style.display = 'inline-block';
                buttonText.style.display = 'none';
            } else {
                submitBtn.disabled = false;
                spinner.style.display = 'none';
                buttonText.style.display = 'inline';
            }
        }
    </script>
</body>

</html>